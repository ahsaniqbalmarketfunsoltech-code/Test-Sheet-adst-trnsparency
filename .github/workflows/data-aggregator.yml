name: Data Aggregator - Twice Daily

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

on:
  schedule:
    # Runs twice daily: 6 AM and 6 PM Pakistan Time (UTC+5)
    # 6 AM PKT = 1:00 AM UTC
    # 6 PM PKT = 1:00 PM UTC
    - cron: '0 1 * * *'   # 6:00 AM PKT
    - cron: '0 13 * * *'  # 6:00 PM PKT
  
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual run'
        required: false
        default: 'Manual trigger'

jobs:
  aggregate-data:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Setup credentials
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
        run: |
          echo "$GOOGLE_CREDENTIALS" > credentials.json

      - name: ğŸ“Š Setup source sheets config
        env:
          SOURCE_SHEETS_CONFIG: ${{ secrets.SOURCE_SHEETS_CONFIG }}
        run: |
          if [ -n "$SOURCE_SHEETS_CONFIG" ]; then
            echo "$SOURCE_SHEETS_CONFIG" > source_sheets.json
          fi

      - name: ğŸš€ Run Data Aggregator
        run: node data_aggregator.js
        env:
          NODE_ENV: production

      - name: ğŸ“ Log completion
        run: |
          echo "âœ… Data aggregation completed at $(date)"
          echo "Trigger: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "Reason: ${{ github.event.inputs.reason }}"
          fi
